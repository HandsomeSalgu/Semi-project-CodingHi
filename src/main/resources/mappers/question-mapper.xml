<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sinuedu.board.qna.model.mapper.QnaMapper">
<select id="getListCount">
SELECT COUNT(*) FROM QNA Q JOIN USERS ON (WRITER = USER_NO) JOIN CATEGORY USING(CG_NO) WHERE Q.STATUS = 'Y'
<if test="category != null and condition != null"> AND NOTICE = #{category} AND ${condition} LIKE '%${search}%' </if>
<if test="category != null and condition == null"> AND NOTICE = #{category} </if>
<if test="category == null and condition != null"> AND ${condition} LIKE '%${search}%' </if>
</select>
<!--  공지글 목록: ROWNUM → LIMIT  -->
<select id="selectNoticeBoardList">
SELECT * FROM QNA Q JOIN USERS ON (WRITER = USER_NO) JOIN CATEGORY USING(CG_NO) WHERE Q.STATUS = 'Y' AND NOTICE = 'Y'
<if test="category != null and condition != null"> AND ${condition} LIKE '%${search}%' </if>
ORDER BY CREATE_DATE DESC
<if test="category == null"> LIMIT 5 </if>
</select>
<select id="selectQnaBoardList">
SELECT * FROM QNA Q JOIN USERS ON (WRITER = USER_NO) JOIN CATEGORY USING(CG_NO) WHERE NOTICE = 'N' AND Q.STATUS = 'Y'
<if test="condition != null"> AND ${condition} LIKE '%${search}%' </if>
ORDER BY QNA_NO DESC
</select>
<select id="selectReply"> SELECT * FROM REPLY R JOIN USERS USING(USER_NO) WHERE QNA_NO = #{qNo} AND R.STATUS = 'Y' ORDER BY REP_NO DESC </select>
<update id="updateCount"> UPDATE QNA SET VIEWS = VIEWS + 1 WHERE QNA_NO = #{QNA_NO} </update>
<!--  AUTO_INCREMENT & DEFAULT 반영  -->
<insert id="insertBoard"> INSERT INTO QNA (QNA_TITLE, QNA_DETAIL, WRITER, VIEWS, CG_NO, NOTICE, STATUS) VALUES (#{qnaTitle}, #{qnaDetail}, #{writer}, #{views}, #{cgNo}, #{notice}, DEFAULT) </insert>
<select id="selectBoard"> SELECT * FROM QNA Q JOIN USERS ON (WRITER = USER_NO) JOIN CATEGORY USING(CG_NO) WHERE QNA_NO = #{qnaNo} AND Q.STATUS = 'Y' </select>
<select id="selectCategory"> SELECT * FROM CATEGORY </select>
<update id="updateBoard"> UPDATE QNA SET QNA_TITLE = #{qnaTitle}, QNA_DETAIL = #{qnaDetail}, UPDATE_DATE = NOW(), CG_NO = #{cgNo}, NOTICE = #{notice} WHERE QNA_NO = #{qnaNo} </update>
<!--  전체 검색 (작성자, 제목, 내용)  -->
<select id="searchAll"> SELECT Q.* FROM QNA Q JOIN USERS U ON Q.WRITER = U.USER_NO WHERE (U.USER_NICK LIKE '%${search}%' OR Q.QNA_TITLE LIKE '%${search}%' OR Q.QNA_DETAIL LIKE '%${search}%') AND Q.STATUS = 'Y' </select>
<delete id="deletePost"> UPDATE QNA SET STATUS = 'N' WHERE QNA_NO = #{qnaNo} </delete>
<select id="PopularQna"> SELECT Q.QNA_NO, Q.QNA_TITLE, Q.QNA_DETAIL, Q.VIEWS, (SELECT COUNT(*) FROM REPLY R WHERE R.QNA_NO = Q.QNA_NO) AS replyCount FROM QNA Q WHERE Q.STATUS = 'Y' ORDER BY Q.VIEWS DESC LIMIT 3 </select>
<select id="getRecentQnaByUser"> SELECT Q.QNA_NO, Q.QNA_TITLE, Q.WRITER, Q.CREATE_DATE, Q.VIEWS, C.CG_NAME FROM QNA Q JOIN CATEGORY C ON Q.CG_NO = C.CG_NO WHERE Q.WRITER = #{userNo} AND Q.STATUS = 'Y' ORDER BY Q.CREATE_DATE DESC LIMIT 5 </select>
<select id="getRecentCommentsByUser" resultType="com.sinuedu.board.qna.model.vo.reply"> SELECT R.REP_NO, R.QNA_NO, R.USER_NO, R.REP_COMMENT, Q.QNA_TITLE, C.CG_NAME FROM REPLY R JOIN QNA Q ON R.QNA_NO = Q.QNA_NO JOIN CATEGORY C ON Q.CG_NO = C.CG_NO WHERE R.USER_NO = #{userNo} AND R.STATUS = 'Y' ORDER BY R.REP_NO DESC LIMIT 5 </select>
<insert id="insertReply"> INSERT INTO REPLY (REP_COMMENT, USER_NO, QNA_NO) VALUES (#{repComment}, #{userNo}, #{qnaNo}) </insert>
<delete id="deleteReply"> UPDATE REPLY SET STATUS = 'N' WHERE REP_NO = #{repNo} </delete>
<update id="updateReply"> UPDATE REPLY SET REP_COMMENT = #{repComment} WHERE REP_NO = #{repNo} </update>
</mapper>